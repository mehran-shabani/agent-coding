# 📘 Master Instructions — Build the Local Coding Agent

# ⚠️ این سند کد نمونه ارائه نمی‌کند؛ فقط «گام‌ها، قراردادها و معیارهای پذیرش» را مشخص می‌نماید.

---

## 0) محدودیت‌ها و اصول

- فقط به صورت لوکال؛ نیاز به هیچ احراز هویتی جز **LLM\_API\_KEY** و **LLM\_BASE\_URL** ندارد.
- باید از کتابخانه‌های زیر استفاده شود:
  - **Typer** برای CLI
  - **Rich** برای نمایش رنگی و خوانا
  - **OpenAI Client** برای ارتباط با LLM (با امکان تعیین base\_url و api\_key)
  - **python-dotenv** برای بارگذاری تنظیمات محیطی
  - **Pydantic** برای مدیریت تنظیمات و داده‌ها
- اجرای دستورات شِل و عملیات فایل باید **ایمن** و با تأیید کاربر برای اقدامات مخرب (حذف / بازنویسی / اعمال Patch) انجام شود.
- هر «تناقض» در دستورالعمل‌ها یا الزامات → فرایند را **متوقف** کنید، گزارش بسازید (`.agent/reports/contradictions-<ts>.md`) و از ادامهٔ خودکار خودداری کنید.
- زبان رابط CLI: انگلیسی کوتاه؛ پیام‌های راهنما و README: فارسی رسمی.
- پیش‌فرض LLM روی **GapGPT** باشد؛ امکان تغییر با متغیر محیطی فراهم باشد.

---

## 1) خروجی نهایی

1. یک مخزن با ساختار دقیق زیر ساخته شود:

   - `pyproject.toml`
   - `README.md`
   - `.env.example`
   - `.gitignore`
   - `agent/`
     - `cli.py`
     - `config.py`
     - `llm.py`
     - `analyze.py`
     - `state.py`
     - `prompts.py`
     - `tools/`
       - `fs.py`
       - `shell.py`
       - `patch.py`
   - `.agent/`
     - `logs/`
     - `reports/`
     - `state.json`

2. CLI با نام باینری `lca` ساخته شود و زیرفرمان‌های زیر را پشتیبانی کند:

   - `whoami`
   - `analyze`
   - `ask`
   - `plan`
   - `todo (add|list|done)`
   - `run`
   - `write`
   - `edit`
   - `delete`
   - `patch`

3. تست‌های دستی مطابق چک‌لیست بخش 8 اجرا شود.

---

## 2) پیکربندی و محیط

- فایل `.env.example` شامل کلیدهای زیر باشد:
  - `LLM_API_KEY`
  - `LLM_BASE_URL` ← مقدار پیش‌فرض: **[https://api.gapgpt.app/v1](https://api.gapgpt.app/v1)**
  - `LLM_MODEL` ← مقدار پیش‌فرض: `gpt-5o`
  - `AGENT_WORKDIR` ← پیش‌فرض: `.`
  - `AGENT_LOG_DIR` ← پیش‌فرض: `.agent/logs`
  - `AGENT_STATE` ← پیش‌فرض: `.agent/state.json`
- اگر `LLM_API_KEY` تعریف نشده باشد، اجرای CLI متوقف شود و پیام خطای روشن نمایش داده شود.

---

## 3) قراردادهای طراحی

- **CLI** باید با Typer پیاده‌سازی شود. هر زیرفرمان `--help` کامل داشته باشد.
- **خروجی ترمینال** باید با Rich نمایش داده شود؛ موفقیت و خطا با کد خروج مناسب مشخص شود.
- **LLM** باید از کلاینت OpenAI استفاده کند:
  - پارامترهای `api_key` و `base_url` از `.env` بارگذاری شود.
  - ابتدا متد `responses.create` استفاده شود؛ اگر خطا رخ داد، از `chat.completions.create` استفاده شود.
- **تحلیل پروژه** باید شامل اسکن کل دایرکتوری، نمایش اندازه فایل‌ها، زبان‌ها و استخراج نمادهای پایتون (کلاس‌ها، توابع، داک‌استرینگ‌ها) باشد. نتیجه در `CODEMAP.md` ذخیره شود.
- **Patch** باید به صورت unified diff تولید شود و قبل از اعمال نمایش داده شود. اعمال تغییر فقط با تأیید یا فلگ `--apply/--yes` مجاز است.
- **اجرای شِل** باید در `AGENT_WORKDIR` انجام شود و خروجی در `.agent/logs/commands-<ts>.log` ذخیره شود.
- **TODO** باید در `.agent/state.json` ذخیره شود. خروجی `todo list` باید به صورت Markdown نیز نمایش داده شود.
- **ایمنی فایل**: هر عملیات حذف یا بازنویسی باید تأیید کاربر داشته باشد؛ تنها در صورت `--yes` بدون تأیید انجام شود.
- **گزارش تناقض**: هر تناقض باید در `.agent/reports/` ذخیره شود و اجرای CLI متوقف گردد.

---

## 4) رفتار زیرفرمان‌ها

- `whoami`: نمایش اطلاعات پیکربندی.
- `analyze [PATH]`: تولید `CODEMAP.md`.
- `ask "..."`: پرسش آزاد و دریافت پاسخ متنی.
- `plan "هدف"`: تولید گام‌ها و افزودن به TODO.
- `todo add|list|done`: مدیریت TODO.
- `run "CMD"`: اجرای فرمان شِل.
- `write --path <file> --from "desc" [--overwrite]`: تولید فایل.
- `edit --path <file> --inst "instruction"`: ویرایش فایل با پچ.
- `delete --path <path> [--yes]`: حذف فایل/پوشه.
- `patch --from "desc" [--apply]`: دریافت و اعمال Patch.

---

## 5) ثبت و لاگ

- همهٔ عملیات باید در `.agent/logs/` با timestamp ذخیره شوند.
- خطاها باید با پیام واضح و کد خروج غیرصفر خاتمه یابند.
- `CODEMAP.md` باید تاریخ و مسیر اسکن را داشته باشد.

---

## 6) پرامپت‌های پایه

- System: «تو یک ایجنت کدنویسی لوکال هستی؛ فقط در workspace تعیین‌شده کار کن؛ تغییرات را به صورت unified diff ارائه بده؛ پاسخ‌ها کوتاه و ایمن باشند.»
- تولید فایل: «توضیح را به فایل اجرایی تبدیل کن؛ ساختار ساده و مینیمال باشد.»
- ویرایش فایل: «فقط بخش‌های لازم تغییر کند؛ خروجی unified diff باشد.»
- پچ چندفایلی: «پچ چندفایلی با مسیر نسبی از ریشهٔ پروژه بده؛ هر فایل در hunk جدا باشد.»

---

## 7) معیار پذیرش

- نصب با `pip install -e .` بدون خطا.
- اجرای `lca --help` لیست زیرفرمان‌ها را نشان دهد.
- اجرای `lca whoami` اطلاعات درست را نمایش دهد.
- اجرای `lca analyze` فایل `CODEMAP.md` ایجاد کند.
- اجرای `lca run "echo test"` خروجی مناسب بدهد و لاگ ذخیره شود.
- اجرای `write` و `edit` رفتار ایمن داشته باشند.
- اجرای `patch --from` پچ معتبر ایجاد کند.
- TODO چرخه add→list→done را پشتیبانی کند.

---

## 8) چک‌لیست تحویل

-

---

## 9) راهبرد خطا و بازیابی

- خطای شبکه LLM: سه بار تلاش مجدد؛ سپس خروج با پیام راهنما.
- خطای دسترسی فایل: پیام روشن + پیشنهاد رفع.
- پچ نامعتبر: ذخیره در `.agent/reports/invalid-patch-<ts>.diff` و توقف.

---

## 10) جریان کاری مخزن و PR

- شاخهٔ کاری: `feature/local-coding-agent/<agent-id>`.
- Commit‌ها اتمیک و توصیفی باشند.
- PR به شاخهٔ `develop` با برچسب‌های `agent`, `cli`, `llm`, `safety`, `ready-for-review`.
- در صورت تناقض: PR با برچسب `blocked-contradiction` و گزارش.

---

## 11) نکات امنیتی

- محتوای `.env` هرگز لاگ نشود.
- مسیرها باید Cross‑Platform باشند.
- اجرای غیرتعاملی فقط با فلگ مجاز باشد.

---

## 12) زمان‌بندی اجرای ایجنت‌ها

- فاز 1: ساختار فایل‌ها و CLI اولیه.
- فاز 2: ابزارها (`fs`, `shell`, `patch`).
- فاز 3: لایه LLM و پرامپت‌ها.
- فاز 4: ماژول تحلیل (`analyze`).
- فاز 5: ماژول state و TODO.
- فاز 6: گزارش تناقض، لاگ‌ها و PR.

---

## 13) جمع‌بندی

این دستورالعمل باید منجر به ساخت یک ایجنت کدنویسی لوکال مدرن و ایمن شود که به طور پیش‌فرض به **GapGPT** متصل است، تمام عملیات فایل و شِل را در لوکال انجام می‌دهد و تغییرات پروژه را با زبان طبیعی مدیریت می‌کند.

